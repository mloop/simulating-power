<!DOCTYPE html>
<html>
  <head>
    <title>Power calculations using simulation</title>
    <meta charset="utf-8">
    <meta name="author" content="Matthew Loop" />
    <meta name="date" content="2019-02-04" />
    <link href="libs/remark-css-0.0.1/default.css" rel="stylesheet" />
    <link href="libs/remark-css-0.0.1/default-fonts.css" rel="stylesheet" />
  </head>
  <body>
    <textarea id="source">
class: center, middle, inverse, title-slide

# Power calculations using simulation
## When you donâ€™t know what the %*#$ to do
### Matthew Loop
### 2019-02-04

---


class: center, middle

# A colleague comes to you...

---

&gt; # I have a cohort study where we have collected data at two time points. We would like to collect data at a third time point. Our key question of interest is whether changes in risk factors for CVD predict changes in subclinical markers of the disease, such as measures of atherosclerosis from imaging data.

---

&gt; # Also, we want each participant to have a random intercept, random slope over time, and allow for non-linearity in the trajectory.

---
class: middle, center
![](index_files/figure-html/unnamed-chunk-1-1.png)&lt;!-- --&gt;


---

class: middle

* ## This collaborator was doing great work, had gotten multiple R01s and was very well-regarded in the community. It was important that this go well.
* ## It was my first time with a power calculation this complicated.
* ## So I fired up my sample size program to look for something...

---

background-image: url("https://thumbs.gfycat.com/AbandonedWetArcticseal-max-1mb.gif")
background-size: cover

---

background-image: url("https://i.pinimg.com/originals/40/4e/e8/404ee85853f8478e056eafc3dc8630ff.jpg")
background-size: cover

---

# Bioethical considerations

* ## What if we use too few?
* ## What if we use too many?

---


# My experience

.middle[
* ## Defended less than 4 years ago
* ## Several power calculations for R01s
    * ## AUC, competing risks (wrote my own code)
]

---
# Using fake data simulation
.middle[
* ## Identified statistical mismatch between design and desired analysis
* ## Came to understand the mixed model better
* ## Wrote code that I can refactor in the future for similar power calculations
]

---

class: center, middle, inverse

# Create data-generating model

---
class: center, middle

## `$$y_{ij} = \beta_0 + \alpha_i + \textrm{time}_{ij}\beta_1 + \textrm{time}_{ij}b_i + \textrm{risk factor}_{ij}\beta_2 + \textrm{time}_{ij}\textrm{risk factor}_{ij}\beta_3 + \epsilon_{ij},$$`  `\(\epsilon_{ij} \sim N(0, 50)\)`

---

# Let's make some assumptions (about things we won't vary)

```r
dataset &lt;- as_tibble(
  expand.grid(
    visit = c("V1", "V2", "V3"),
    risk_factor = c(0, 1)
  )
) %&gt;%
  group_by(visit, risk_factor) %&gt;%
  nest() %&gt;%
  mutate(
    random_data = 
      map(data, ~data.frame(random_intercept = rnorm(n, 0, 10),
                            random_slope = rnorm(n, 0, .5),
                            id = seq(1, n, 1),
                            years_since_last_visit = runif(n, 1, 3)) %&gt;% as_tibble())
  )
```

---

# Generate time on study

```r
mutate(years_since_last_visit = if_else(visit == "V1", 
                                        0, 
                                        years_since_last_visit), 
       time = lag(years_since_last_visit, default = 0) + years_since_last_visit, 
       time_linear_spline = if_else(time &lt;= nth(time, 2), 
                                    0, 
                                    time - nth(time, 2)))
```

---

# Generate realizations of outcome


```r
mutate(
    imt = rnorm(1, 
                150 + random_intercept + 
                time * 2.5 + 
                risk_factor * 10 + 
                time * risk_factor * interaction_coefficient + 
                time * random_slope, 
                50)
  ) 
```

## I ended up varying `interaction_coefficient` from 1 to 5, by increments of 1

---
class: center, middle, inverse
# Perform planned analysis on simulated datasets

---



```r
mutate(
    simulated_dataset = map(
      interaction_coefficient, 
      ~create_dataset(.)),
    model_fit = map(
      simulated_dataset, 
      ~lmer(imt ~ (1 + time | id) + 
                  time * risk_factor, 
            data = .)),
    interaction_pvalue = map_dbl(
      model_fit, 
      ~anova(.) %&gt;% 
       tidy() %&gt;% 
       dplyr::select(term, p.value) %&gt;% 
       filter(term == "time:risk_factor") %&gt;% 
       dplyr::select(p.value) %&gt;% 
       as.numeric())
    )
```

---

# Evaluate power

```r
mutate(p_value_lt_0.1 = if_else(interaction_pvalue &lt; 0.1, 1, 0)) %&gt;%
  group_by(interaction_coefficient) %&gt;%
  summarise(power = mean(p_value_lt_0.1))
```

---
class: center, middle, inverse
# Create great plots

---
class: center, middle

&lt;img src="grid_plot.png" width="4000" /&gt;


---
class: center, middle, inverse

# Use fake data simulation when designing a study!

---
# Advantages

##* Correct power calculations for any model you can write down
##* Compare statistal tests you are considering
##* Your assumptions are crystal clear
##* Identify issues with proposed data analysis
##* Provide example figures to investigator
    </textarea>
<script src="https://remarkjs.com/downloads/remark-latest.min.js"></script>
<script>var slideshow = remark.create({
"highlightStyle": "github",
"highlightLines": true,
"countIncrementalSlides": false
});
if (window.HTMLWidgets) slideshow.on('afterShowSlide', function (slide) {
  window.dispatchEvent(new Event('resize'));
});
(function() {
  var d = document, s = d.createElement("style"), r = d.querySelector(".remark-slide-scaler");
  if (!r) return;
  s.type = "text/css"; s.innerHTML = "@page {size: " + r.style.width + " " + r.style.height +"; }";
  d.head.appendChild(s);
})();</script>

<script>
(function() {
  var i, text, code, codes = document.getElementsByTagName('code');
  for (i = 0; i < codes.length;) {
    code = codes[i];
    if (code.parentNode.tagName !== 'PRE' && code.childElementCount === 0) {
      text = code.textContent;
      if (/^\\\((.|\s)+\\\)$/.test(text) || /^\\\[(.|\s)+\\\]$/.test(text) ||
          /^\$\$(.|\s)+\$\$$/.test(text) ||
          /^\\begin\{([^}]+)\}(.|\s)+\\end\{[^}]+\}$/.test(text)) {
        code.outerHTML = code.innerHTML;  // remove <code></code>
        continue;
      }
    }
    i++;
  }
})();
</script>
<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
(function () {
  var script = document.createElement('script');
  script.type = 'text/javascript';
  script.src  = 'https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-MML-AM_CHTML';
  if (location.protocol !== 'file:' && /^https?:/.test(script.src))
    script.src  = script.src.replace(/^https?:/, '');
  document.getElementsByTagName('head')[0].appendChild(script);
})();
</script>
  </body>
</html>
